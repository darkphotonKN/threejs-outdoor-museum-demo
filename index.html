<!DOCTYPE html>
<html lang="zh-TW">
<head>
	<meta charset="UTF-8" />
	<title>demo</title>
	<link type="text/css" rel="stylesheet" href="main.css" />
</head>
<body>
	<div id="info">three.js - museum-demo.</div>
	<!-- <div id="blocker">
		<div id="instructions">
			<span style="font-size: 40px">點擊開始</span>
			<br />
			<br />
			(W, A, S, D = 移動, 滑鼠移動 = 移動視角, ESC = 結束)
		</div>
	</div> -->

	<script type="module">
		import * as THREE from "../build/three.module.js";

		import { GUI } from "./jsm/libs/dat.gui.module.js";
		import { OrbitControls } from "./jsm/controls/OrbitControls.js";
		import { PointerLockControls } from "./jsm/controls/PointerLockControls.js";
		import { GLTFLoader } from './jsm/loaders/GLTFLoader.js';
		import { OBJLoader } from './jsm/loaders/OBJLoader.js';
		import { MTLLoader } from './jsm/loaders/MTLLoader.js';
		import { ColladaLoader } from './jsm/loaders/ColladaLoader.js';
		import Stats from "./jsm/libs/stats.module.js";

		let renderer, camera, scene, gui, light, stats, controls;

		// camera
		const VIEW_ANGLE = 45;
		const ASPECT = window.innerWidth / window.innerHeight;
		const NEAR = 1;
		const FAR = 1000;

		//move
		var moveForward = false;
		var moveBackward = false;
		var moveLeft = false;
		var moveRight = false;
		var raycaster;
		var objects = [];
		var prevTime = performance.now();
		const velocity = new THREE.Vector3();

		draw();

		function initRender() {
			renderer = new THREE.WebGLRenderer({ antialias: true });
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize(window.innerWidth, window.innerHeight); // 場景大小
			renderer.setClearColor(0x000000, 1.0); // 預設背景顏色
			renderer.shadowMap.enable = true // 陰影效果

			document.body.appendChild(renderer.domElement);
		}

		function initCamera() {
			camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
			camera.position.set(100, 100, 100);
			camera.lookAt(scene.position);
			// camera.lookAt(new THREE.Vector3(-10, 10, 10));
		}

		function initScene() {
			scene = new THREE.Scene();
		}

		function initGUI(){
			// gui controls
			const gui = new GUI();
		}


		function initLight() {
			scene.add(new THREE.AmbientLight(0x444444));
			light = new THREE.DirectionalLight(0xffffff);//光源颜色
			light.position.set(100, 100, 100);//光源位置
			scene.add(light);//光源添加到场景中

			// light = new THREE.PointLight(0xffffff);
			// light.position.set(500, 500, 500);
			// light.castShadow = true;
			// scene.add(light);

			// const light = new THREE.HemisphereLight( 0xffffbb, 0x080820, 1 );
			// scene.add( light );
		}

		function initModel() {
			//辅助工具 三角定位
			var helper = new THREE.AxesHelper(100);
			scene.add(helper);

			//#region obj mtl loader
			//建立mtl檔案載入器
			// var mtlLoader = new MTLLoader();
			// //載入mtl檔案，mtl檔案中引用的圖片路徑需要改為相對路徑
			// mtlLoader.load('obj/台科建築畢業展覽.mtl', function(material) {
			// 	//建立obj檔案載入器
			// 	var objLoader = new OBJLoader();
			// 	//設定當前載入的紋理
			// 	objLoader.setMaterials(material);
			// 	//載入obj檔案
			// 	objLoader.load('obj/台科建築畢業展覽.obj', function(object) {
			// 		object.scale.set(0.2, 0.2, 0.2);
            //         object.traverse(function (child) {
            //             child.castShadow = true;
            //             child.receiveShadow = true;
            //             objects.push(child);
            //         }, {normalizeRGB: true});
			// 		scene.add(object);
			// 	});
			// });
			//#endregion

			//#region GLTF loader
			//建立GLTF檔案載入器
			// const loader = new GLTFLoader();
			// loader.load( 'path/to/model.glb', function ( gltf ) {
			// 	scene.add(gltf.scene);
			// }, undefined, function ( error ) {
			// 	console.error( error );
			// } );
			//#endregion
			
			//#region dae loader
			//建立dae檔案載入器
			var loader = new ColladaLoader();
			loader.load('dae/台科建築畢業展覽.dae', function (collada) {
				const dae = collada.scene;
				console.log("x:" + dae.position.x);
				console.log("y:" + dae.position.y);
				console.log("z:" + dae.position.z);
				scene.add(collada.scene);
				setModelPosition(dae)
			});
			//#endregion
		}

		function setModelPosition(object) { 
			object.updateMatrixWorld();
			const box = new THREE.Box3().setFromObject(object);
			const boxSize = box.getSize();
			const center = box.getCenter(new THREE.Vector3());
			object.position.x += object.position.x - center.x;
			object.position.y += object.position.y - center.y; 
			object.position.z += object.position.z - center.z;
		}


		function initStats() {
			stats = new Stats();
			document.body.appendChild(stats.dom);
		}

		function initControls() {

			//#region  要用上帝視角用這個
			controls = new OrbitControls(camera, renderer.domElement );
			controls.enableDamping = true // 啟用阻尼效果
			controls.dampingFactor = 0.25 // 阻尼系數
			//相机与模型最小距离，模型看上去大
            controls.minDistance = 1;
            //相机与模型最大距离，模型看上去小
            controls.maxDistance = 1000;
			//#endregion

			//#region 要走路用這個
			// const blocker = document.getElementById('blocker');
			// blocker.addEventListener('click', function () {
			// 	controls.lock();
			// }, false);

			// controls = new PointerLockControls(camera);
			// controls.addEventListener("lock", () => (blocker.style.display = "none"));
			// controls.addEventListener("unlock", () => (blocker.style.display = "block"));
			// scene.add(controls.getObject());
			// raycaster = new THREE.Raycaster(
			// new THREE.Vector3(),
			// new THREE.Vector3(-135, 0, 370),0,10);

			// var onKeyDown = function (event) {
			// switch (event.keyCode) {
			// 	case 38: // up
			// 	case 87: // w
			// 	moveForward = true;
			// 	break;
			// 	case 37: // left
			// 	case 65: // a
			// 	moveLeft = true;
			// 	break;
			// 	case 40: // down
			// 	case 83: // s
			// 	moveBackward = true;
			// 	break;
			// 	case 39: // right
			// 	case 68: // d
			// 	moveRight = true;
			// 	break;
			// }
			// };
			// var onKeyUp = function (event) {
			// switch (event.keyCode) {
			// 	case 38: // up
			// 	case 87: // w
			// 	moveForward = false;
			// 	break;
			// 	case 37: // left
			// 	case 65: // a
			// 	moveLeft = false;
			// 	break;
			// 	case 40: // down
			// 	case 83: // s
			// 	moveBackward = false;
			// 	break;
			// 	case 39: // right
			// 	case 68: // d
			// 	moveRight = false;
			// 	break;
			// }
			// };
			// document.addEventListener("keydown", onKeyDown, false);
			// document.addEventListener("keyup", onKeyUp, false);
			//#endregion
		}

		function render() {
			renderer.render(scene, camera);
		}

		function onWindowResize(){
    		camera.aspect = window.innerWidth / window.innerHeight;
    		camera.updateProjectionMatrix();
    		renderer.setSize(window.innerWidth, window.innerHeight);
		}

		function animate() {
			
			requestAnimationFrame(animate);
			//更新控制器
			render();

			// raycaster.ray.origin.copy( controls.getObject().position );
			// raycaster.ray.origin.y -= 10;
			// var intersections = raycaster.intersectObjects( objects );
			// var isOnObject = intersections.length > 0;
			// var time = performance.now();
			// var delta = ( time - prevTime ) / 1000;
			// velocity.x -= velocity.x * 10.0 * delta;
			// velocity.z -= velocity.z * 10.0 * delta;
			// velocity.y -= velocity.y * 10.0 * delta; // 100.0 = mass
			// if ( moveForward ) velocity.z -= 400.0 * delta;
			// if ( moveBackward ) velocity.z += 400.0 * delta;
			// if ( moveLeft ) velocity.x -= 400.0 * delta;
			// if ( moveRight ) velocity.x += 400.0 * delta;
			// if ( isOnObject === true ) {
			// 	velocity.y = Math.max( 0, velocity.y );
			// }
			// controls.getObject().translateX( velocity.x * delta );
			// controls.getObject().translateY( velocity.y * delta );
			// controls.getObject().translateZ( velocity.z * delta );
			// if ( controls.getObject().position.y < 10 ) {
			// 	velocity.y = 0;
			// 	controls.getObject().position.y = 0;
			// }
			// prevTime = time;


			//更新性能插件
			stats.update();
			controls.update();
		}

		function draw() {
			initRender();
			initScene();
			initCamera();
			initGUI();
			initLight();
			initModel();
			initControls();
			initStats();
			animate();
			
			window.onresize = onWindowResize;
		}
	</script>
</body>

</html>